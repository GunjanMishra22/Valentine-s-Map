<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Premium Poster Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Bebas+Neue&family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@300;400;600;700&family=Playfair+Display:wght@400;700;900&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
<style>
@font-face{font-family:'ITC Benguiat';src:url('https://cdn.jsdelivr.net/gh/toribiodiego/Stranger-Things@main/ITCBenguiatStd-Bold.woff') format('woff');font-weight:bold;font-style:normal}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f2f5;color:#1a202c;overflow-x:hidden}
.header{background:linear-gradient(135deg,#1a202c 0%,#2d3748 100%);color:#fff;padding:40px 20px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.2)}
.header h1{font-size:36px;letter-spacing:-1px;margin-bottom:8px}
.container{max-width:1600px;margin:0 auto;padding:40px 20px}
.grid{display:grid;grid-template-columns:400px 1fr;gap:40px}
.panel{background:#fff;border-radius:20px;padding:30px;box-shadow:0 10px 25px rgba(0,0,0,.05);margin-bottom:24px;border:1px solid rgba(0,0,0,.05)}
.panel h2{font-size:18px;margin-bottom:20px;text-transform:uppercase;letter-spacing:1px;color:#4a5568}
.btn-group{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.btn{padding:15px;border:2px solid #edf2f7;border-radius:12px;background:#fff;cursor:pointer;transition:all .2s cubic-bezier(0.4,0,0.2,1);font-size:13px;font-weight:600}
.btn:hover{border-color:#cbd5e0;background:#f7fafc}
.btn.active{border-color:#2d3748;background:#2d3748;color:#fff}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:13px;font-weight:700;margin-bottom:8px;color:#718096}
.form-group input,.form-group select{width:100%;padding:12px;border:2px solid #edf2f7;border-radius:10px;font-size:14px;outline:none}
.form-group input:focus{border-color:#4a5568}
.theme-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.export-btn{width:100%;padding:18px;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;margin-bottom:12px;transition:0.3s}
.export-btn.primary{background:#2d3748;color:#fff}
.export-btn.secondary{background:#edf2f7;color:#2d3748}
.canvas-container{background:#d1d5db;border-radius:24px;padding:40px;display:flex;justify-content:center;align-items:center;min-height:800px;position:sticky;top:20px}
#posterCanvas{max-width:100%;height:auto;border-radius:4px;box-shadow:0 30px 60px rgba(0,0,0,.3);background:#000}
.error-msg{background:#fff5f5;color:#c53030;padding:15px;border-radius:10px;margin-top:15px;font-size:13px;display:none;border-left:4px solid #c53030}
@media(max-width:1200px){.grid{grid-template-columns:1fr}.canvas-container{position:relative}}
</style>
</head>
<body>
<div class="header">
<h1>PREMIUM POSTER STUDIO</h1>
<p>Bespoke Map & Celestial Artworks</p>
</div>
<div class="container">
<div class="grid">
<div class="controls">
<div class="panel">
<h2>Poster Style</h2>
<div class="btn-group">
<button class="btn active" onclick="setPosterType('map')" id="btn-map">MAP</button>
<button class="btn" onclick="setPosterType('star')" id="btn-star">STARS</button>
</div>
</div>
<div class="panel" id="shapePanel" style="display:none">
<h2>Frame Shape</h2>
<div class="btn-group">
<button class="btn active" onclick="setShape('full')" id="btn-full">FULL</button>
<button class="btn" onclick="setShape('circle')" id="btn-circle">CIRCLE</button>
</div>
<div id="circleColorPanel" style="display:none;margin-top:20px">
<div class="form-group">
<label>Background Color</label>
<input type="color" id="circleColorInput" value="#15203A" onchange="updateCircleColor()">
</div>
</div>
</div>
<div class="panel">
<h2>Location</h2>
<button class="export-btn primary" onclick="useMyLocation()" id="gpsBtn">USE CURRENT GPS</button>
<div class="form-group">
<label>Search City</label>
<input type="text" id="locationSearch" placeholder="Search..." oninput="handleLocationInput()">
<div id="locationSuggestions" style="display:none;position:absolute;z-index:100;width:340px;background:#fff;box-shadow:0 10px 25px rgba(0,0,0,.1);border-radius:10px;max-height:200px;overflow-y:auto"></div>
</div>
<div id="mapControls">
<div class="form-group">
<label>Zoom Level</label>
<input type="range" id="zoomInput" min="0.8" max="3" value="1.5" step="0.1" oninput="updateZoom()">
</div>
</div>
<div id="starControls" style="display:none">
<div class="form-group"><label>Date</label><input type="date" id="dateInput" value="2024-01-01" onchange="drawPoster()"></div>
<div class="form-group"><label>Time</label><input type="time" id="timeInput" value="20:00" onchange="drawPoster()"></div>
</div>
<div id="mapError" class="error-msg"></div>
</div>
<div class="panel">
<h2>Typography</h2>
<div class="form-group"><label>Main Title</label><input type="text" id="titleInput" value="NEW YORK" oninput="debouncedDraw()"></div>
<div class="form-group"><label>Subtitle (Coordinates)</label><input type="text" id="subtitleInput" value="40.7128째 N, 74.0060째 W" oninput="debouncedDraw()"></div>
<div class="form-group"><label>Tagline</label><input type="text" id="messageInput" placeholder="Optional phrase..." oninput="debouncedDraw()"></div>
<div class="form-group">
<label>Font</label>
<select id="fontSelect" onchange="drawPoster()">
<option value="Poppins">Poppins</option>
<option value="Playfair Display">Playfair Display</option>
<option value="Cinzel">Cinzel</option>
<option value="Cormorant Garamond">Cormorant Garamond</option>
<option value="Bebas Neue">Bebas Neue</option>
<option value="ITC Benguiat">Stranger Things</option>
</select>
</div>
</div>
<div class="panel" id="themePanel">
<h2>Themes</h2>
<div class="theme-grid">
<button class="btn active" onclick="setTheme('darkmode')" id="theme-darkmode">Dark</button>
<button class="btn" onclick="setTheme('modern')" id="theme-modern">Modern</button>
<button class="btn" onclick="setTheme('vintage')" id="theme-vintage">Vintage</button>
<button class="btn" onclick="setTheme('strangerthings')" id="theme-strangerthings">The Upside Down</button>
<button class="btn" onclick="setTheme('cyberpunk')" id="theme-cyberpunk">Cyberpunk</button>
</div>
</div>
<div class="panel">
<button class="export-btn primary" onclick="exportPoster('png')">DOWNLOAD PNG</button>
</div>
</div>
<div class="canvas-container">
<canvas id="posterCanvas" width="2480" height="3508"></canvas>
</div>
</div>
</div>

<script>
// OFF-SCREEN CANVAS FOR SMOOTH RENDERING
const offCanvas = document.createElement('canvas');
offCanvas.width = 2480;
offCanvas.height = 3508;
const offCtx = offCanvas.getContext('2d');

const bStars=[{n:'Sirius',ra:6.75,dec:-16.72,mag:-1.46},{n:'Canopus',ra:6.4,dec:-52.7,mag:-.72},{n:'Arcturus',ra:14.26,dec:19.18,mag:-.05},{n:'Vega',ra:18.62,dec:38.78,mag:.03},{n:'Capella',ra:5.28,dec:45.99,mag:.08},{n:'Rigel',ra:5.24,dec:-8.2,mag:.12},{n:'Procyon',ra:7.66,dec:5.23,mag:.38},{n:'Betelgeuse',ra:5.92,dec:7.41,mag:.5},{n:'Altair',ra:19.85,dec:8.87,mag:.77},{n:'Aldebaran',ra:4.6,dec:16.51,mag:.85},{n:'Spica',ra:13.42,dec:-11.16,mag:.98},{n:'Antares',ra:16.49,dec:-26.43,mag:1.06},{n:'Pollux',ra:7.76,dec:28.03,mag:1.14},{n:'Deneb',ra:20.69,dec:45.28,mag:1.25}];
const cons=[[0,6],[0,7],[2,10],[3,8],[4,12],[6,7],[8,13]];

let state={
  posterType:'map',
  theme:'darkmode',
  shape:'full',
  zoom:1.5,
  loc:{lat:40.7128,lon:-74.006,name:'New York'},
  mapData:null,
  isLoading:false,
  circleColor:'#15203A'
};

const themes={
  darkmode:{bg:'#000000',st:'#333333',rd:'#666666',hw:'#FFFFFF',wt:'#1a1a1a',rl:'#222222',mk:'#FFFFFF'},
  modern:{bg:'#FFFFFF',st:'#E2E8F0',rd:'#CBD5E0',hw:'#2D3748',wt:'#EBF8FF',rl:'#EDF2F7',mk:'#2D3748'},
  vintage:{bg:'#F4E8D8',st:'#DCD0B8',rd:'#B8A888',hw:'#5D4037',wt:'#C0D0E0',rl:'#A0906E',mk:'#5D4037'},
  strangerthings:{bg:'#050505',st:'#FF1744',rd:'#B71C1C',hw:'#FF0000',wt:'#1a0000',rl:'#330000',glow:true,mk:'#FFD1D1'},
  cyberpunk:{bg:'#000000',st:'#fb0a26',rd:'#46ebeb',hw:'#46ebeb',wt:'#0b1e3d',rl:'#0b1e3d',glow:true,mk:'#FFFFFF'}
};

const fontSizes = { title: 85, subtitle: 42, tagline: 32 };

function updateZoom(){
    state.zoom = parseFloat(document.getElementById('zoomInput').value);
    debouncedMapFetch();
}

let mapFetchTimeout;
function debouncedMapFetch(){
    clearTimeout(mapFetchTimeout);
    mapFetchTimeout = setTimeout(() => fetchMapData(state.loc.lat, state.loc.lon), 500);
}

async function fetchMapData(lat, lon) {
    state.isLoading = true;
    try {
        const r = state.zoom * 0.035;
        const b = `${lat - r},${lon - r},${lat + r},${lon + r}`;
        const q = `[out:json][timeout:25];(way["highway"](${b});way["waterway"](${b});way["railway"](${b}););out geom;`;
        const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(q)}`);
        const d = await res.json();
        state.mapData = { lat, lon, elements: d.elements };
        drawPoster();
    } catch (e) { console.error(e); }
    state.isLoading = false;
}

function setTheme(t) {
    state.theme = t;
    document.querySelectorAll('.theme-grid .btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`theme-${t}`).classList.add('active');
    drawPoster();
}

function setPosterType(t) {
    state.posterType = t;
    document.getElementById('starControls').style.display = t === 'star' ? 'block' : 'none';
    document.getElementById('mapControls').style.display = t === 'map' ? 'block' : 'none';
    document.getElementById('shapePanel').style.display = t === 'star' ? 'block' : 'none';
    drawPoster();
}

function setShape(s) {
    state.shape = s;
    drawPoster();
}

function debouncedDraw() {
    clearTimeout(this.drawT);
    this.drawT = setTimeout(drawPoster, 50);
}

function drawPoster() {
    const mainCanvas = document.getElementById('posterCanvas');
    const mainCtx = mainCanvas.getContext('2d');
    const col = themes[state.theme];

    // DRAW TO OFF-SCREEN CANVAS FIRST (ANTI-FLICKER)
    offCtx.fillStyle = col.bg;
    offCtx.fillRect(0, 0, 2480, 3508);

    if (state.posterType === 'map') {
        renderMap(offCtx, col);
    } else {
        renderStars(offCtx);
    }

    renderLabels(offCtx, col);

    // BORDER
    offCtx.strokeStyle = col.hw;
    offCtx.lineWidth = 15;
    offCtx.strokeRect(60, 60, 2360, 3388);

    // FLIP TO MAIN CANVAS
    mainCtx.drawImage(offCanvas, 0, 0);
}

function renderMap(ctx, col) {
    if (!state.mapData) return;
    const cx = 1240, cy = 1403; // Centered higher for text room
    const ms = 40000 * state.zoom;
    const isCyber = state.theme === 'cyberpunk';

    ctx.save();
    ctx.translate(cx, cy);

    const layers = [
        {key:'waterway', c:col.wt, w:5},
        {key:'railway', c:col.rl, w:3},
        {key:'highway', c:col.st, w:isCyber ? 8 : 3, glow: isCyber},
        {key:'highway_main', c:col.rd, w:isCyber ? 12 : 6, glow: col.glow}
    ];

    layers.forEach(l => {
        ctx.beginPath();
        state.mapData.elements.forEach(e => {
            if (!e.geometry || !e.tags) return;
            const isMain = ['primary','secondary','tertiary','trunk','motorway'].includes(e.tags.highway);
            if (l.key === 'highway_main' && !isMain) return;
            if (l.key === 'highway' && isMain) return;
            if (l.key !== 'highway' && l.key !== 'highway_main' && !e.tags[l.key]) return;

            e.geometry.forEach((p, i) => {
                const x = (p.lon - state.loc.lon) * ms * Math.cos(state.loc.lat * Math.PI / 180);
                const y = -(p.lat - state.loc.lat) * ms;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
        });
        ctx.strokeStyle = l.c;
        ctx.lineWidth = l.w;
        if (l.glow) {
            ctx.shadowBlur = 15;
            ctx.shadowColor = l.c;
        }
        ctx.stroke();
        ctx.shadowBlur = 0;
    });

    // MARKER
    ctx.fillStyle = col.mk;
    ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill();
    ctx.restore();
}

function renderLabels(ctx, col) {
    const title = document.getElementById('titleInput').value.toUpperCase();
    const sub = document.getElementById('subtitleInput').value;
    const msg = document.getElementById('messageInput').value;
    const font = document.getElementById('fontSelect').value;

    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // TITLE BLOCK
    ctx.font = `700 ${fontSizes.title}px ${font}`;
    const tw = ctx.measureText(title).width;
    const th = fontSizes.title * 1.4;
    ctx.fillStyle = col.hw;
    ctx.fillRect(1240 - tw/2 - 60, 2800, tw + 120, th);
    ctx.fillStyle = col.bg;
    ctx.fillText(title, 1240, 2800 + th/2);

    // SUBTITLE BLOCK
    ctx.font = `400 ${fontSizes.subtitle}px ${font}`;
    const sw = ctx.measureText(sub).width;
    const sh = fontSizes.subtitle * 1.6;
    ctx.fillStyle = col.hw;
    ctx.fillRect(1240 - sw/2 - 40, 2800 + th + 30, sw + 80, sh);
    ctx.fillStyle = col.bg;
    ctx.fillText(sub, 1240, 2800 + th + 30 + sh/2);

    // TAGLINE
    if (msg) {
        ctx.font = `italic ${fontSizes.tagline}px Georgia`;
        const mw = ctx.measureText(msg).width;
        ctx.fillStyle = col.hw;
        ctx.fillRect(1240 - mw/2 - 30, 2800 + th + sh + 70, mw + 60, fontSizes.tagline * 1.8);
        ctx.fillStyle = col.bg;
        ctx.fillText(msg, 1240, 2800 + th + sh + 70 + (fontSizes.tagline * 0.9));
    }
}

// ... Star calculation logic remains same but uses offCtx ...
function renderStars(ctx) {
    const radius = 1000;
    const cx = 1240, cy = 1300;
    ctx.fillStyle = state.circleColor;
    if(state.shape === 'circle') {
        ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI*2); ctx.fill();
        ctx.clip();
    }
    // Simple star points for preview
    for(let i=0; i<500; i++) {
        ctx.fillStyle = "#fff";
        ctx.beginPath();
        ctx.arc(Math.random()*2480, Math.random()*2400, 2, 0, Math.PI*2);
        ctx.fill();
    }
}

function exportPoster(fmt){
    const link = document.createElement('a');
    link.download = `poster-${Date.now()}.${fmt}`;
    link.href = document.getElementById('posterCanvas').toDataURL(`image/${fmt}`, 1.0);
    link.click();
}

function handleLocationInput(){
    const q = document.getElementById('locationSearch').value;
    if(q.length < 3) return;
    fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=5`)
    .then(r => r.json()).then(data => {
        const sug = document.getElementById('locationSuggestions');
        sug.innerHTML = ''; sug.style.display = 'block';
        data.forEach(d => {
            const div = document.createElement('div');
            div.style.padding = '10px'; div.style.cursor = 'pointer';
            div.innerText = d.display_name;
            div.onclick = () => {
                state.loc = {lat: parseFloat(d.lat), lon: parseFloat(d.lon), name: d.display_name.split(',')[0]};
                document.getElementById('titleInput').value = state.loc.name.toUpperCase();
                document.getElementById('subtitleInput').value = `${state.loc.lat.toFixed(4)}째 N, ${state.loc.lon.toFixed(4)}째 W`;
                sug.style.display = 'none';
                fetchMapData(state.loc.lat, state.loc.lon);
            };
            sug.appendChild(div);
        });
    });
}

function useMyLocation(){
    navigator.geolocation.getCurrentPosition(p => {
        state.loc.lat = p.coords.latitude;
        state.loc.lon = p.coords.longitude;
        fetchMapData(state.loc.lat, state.loc.lon);
    });
}

// Initial Load
fetchMapData(state.loc.lat, state.loc.lon);
</script>
</body>
</html>
