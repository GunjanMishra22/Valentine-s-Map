<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultra-Smooth Premium Poster Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Bebas+Neue&family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@300;400;600;700&family=Playfair+Display:wght@400;700;900&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">

<style>
@font-face{font-family:'ITC Benguiat';src:url('https://cdn.jsdelivr.net/gh/toribiodiego/Stranger-Things@main/ITCBenguiatStd-Bold.woff') format('woff');font-weight:bold;font-style:normal}

/* --- RESET & BASE --- */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f2f5;color:#1a202c;height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* --- LAYOUT --- */
.app-container { display: flex; height: 100vh; width: 100vw; }

/* --- SIDEBAR CONTROLS --- */
.sidebar {
    width: 420px;
    background: #fff;
    border-right: 1px solid #e2e8f0;
    overflow-y: auto;
    padding: 30px;
    display: flex;
    flex-direction: column;
    gap: 25px;
    box-shadow: 4px 0 24px rgba(0,0,0,0.05);
    z-index: 10;
}

.header h1 { font-family: 'Cinzel', serif; font-size: 28px; color: #1a202c; letter-spacing: -0.5px; margin-bottom: 5px; }
.header p { color: #718096; font-size: 14px; margin-bottom: 20px; border-bottom: 1px solid #edf2f7; padding-bottom: 20px; }

.panel-section h2 { font-size: 12px; font-weight: 700; text-transform: uppercase; color: #a0aec0; letter-spacing: 1.2px; margin-bottom: 12px; }

/* --- INPUTS & BUTTONS --- */
.btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
.btn { flex: 1; padding: 12px; border: 1px solid #e2e8f0; background: #fff; border-radius: 8px; font-weight: 600; font-size: 13px; color: #4a5568; cursor: pointer; transition: all 0.2s; }
.btn:hover { background: #f7fafc; border-color: #cbd5e0; }
.btn.active { background: #2d3748; color: #fff; border-color: #2d3748; box-shadow: 0 4px 12px rgba(45, 55, 72, 0.2); }

.form-group { margin-bottom: 15px; position: relative; }
.form-group label { display: block; font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 6px; }
.form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #edf2f7; border-radius: 8px; font-size: 14px; transition: border 0.2s; }
.form-group input:focus, .form-group select:focus { border-color: #4a5568; outline: none; }

.theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

.action-btn { width: 100%; padding: 16px; background: #2d3748; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 15px; margin-top: auto; transition: transform 0.1s; }
.action-btn:hover { background: #1a202c; }
.action-btn:active { transform: scale(0.98); }

/* --- PREVIEW AREA --- */
.canvas-wrapper {
    flex: 1;
    background: #cbd5e0;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
    position: relative;
    overflow: hidden;
}

#posterCanvas {
    max-height: 90vh;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
    background: #000;
    border-radius: 2px;
}

/* --- UTILS --- */
#loadingOverlay {
    position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8); color: white;
    padding: 15px 30px; border-radius: 30px;
    font-weight: 600; backdrop-filter: blur(5px);
    display: none; pointer-events: none; z-index: 20;
}

#suggestions {
    position: absolute; top: 100%; left: 0; right: 0;
    background: white; border: 1px solid #e2e8f0;
    border-radius: 8px; z-index: 50; max-height: 200px;
    overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    display: none;
}
.suggestion-item { padding: 10px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f0f0f0; }
.suggestion-item:hover { background: #f7fafc; }

</style>
</head>
<body>

<div class="app-container">
    
    <div class="sidebar">
        <div class="header">
            <h1>Poster Studio</h1>
            <p>Design premium map & star prints.</p>
        </div>

        <div class="panel-section">
            <h2>Style & Mode</h2>
            <div class="btn-group">
                <button class="btn active" onclick="setMode('map')" id="btn-map">Map</button>
                <button class="btn" onclick="setMode('star')" id="btn-star">Stars</button>
            </div>
            <div class="theme-grid">
                <button class="btn active" onclick="setTheme('darkmode')" id="t-darkmode">Dark</button>
                <button class="btn" onclick="setTheme('modern')" id="t-modern">Modern</button>
                <button class="btn" onclick="setTheme('vintage')" id="t-vintage">Vintage</button>
                <button class="btn" onclick="setTheme('cyberpunk')" id="t-cyberpunk">Cyber</button>
            </div>
        </div>

        <div class="panel-section" id="map-controls">
            <h2>Location</h2>
            <div class="form-group">
                <label>Search City</label>
                <input type="text" id="cityInput" placeholder="New York, Tokyo..." oninput="handleSearch()">
                <div id="suggestions"></div>
            </div>
            <div class="form-group">
                <label>Zoom</label>
                <input type="range" id="zoomRange" min="0.5" max="3.0" step="0.1" value="1.5" oninput="updateZoom()">
            </div>
        </div>

        <div class="panel-section">
            <h2>Typography</h2>
            <div class="form-group">
                <label>Headline</label>
                <input type="text" id="txtTitle" value="NEW YORK" oninput="drawLabelsOnly()">
            </div>
            <div class="form-group">
                <label>Coordinates / Subtitle</label>
                <input type="text" id="txtSub" value="40.7128째 N / 74.0060째 W" oninput="drawLabelsOnly()">
            </div>
            <div class="form-group">
                <label>Tagline</label>
                <input type="text" id="txtTag" placeholder="The city that never sleeps" oninput="drawLabelsOnly()">
            </div>
            <div class="form-group">
                <label>Font Family</label>
                <select id="fontSelect" onchange="drawLabelsOnly()">
                    <option value="Poppins">Poppins (Modern)</option>
                    <option value="Playfair Display">Playfair (Elegant)</option>
                    <option value="Cinzel">Cinzel (Classic)</option>
                    <option value="Bebas Neue">Bebas Neue (Tall)</option>
                    <option value="ITC Benguiat">Stranger Things</option>
                </select>
            </div>
        </div>

        <button class="action-btn" onclick="downloadPoster()">DOWNLOAD HD POSTER</button>
    </div>

    <div class="canvas-wrapper">
        <div id="loadingOverlay">Generative Process Active...</div>
        <canvas id="posterCanvas" width="2480" height="3508" style="height: 90%; width: auto;"></canvas>
    </div>

</div>

<script>
/** * STATE MANAGEMENT
 */
const state = {
    mode: 'map', // 'map' or 'star'
    theme: 'darkmode',
    lat: 40.7128,
    lon: -74.0060,
    zoom: 1.5,
    mapData: null,
    isFetching: false
};

const themes = {
    darkmode: { bg: '#050505', lines: '#333', roads: '#555', water: '#0a0a0a', textBg: '#FFFFFF', text: '#000000', frame: '#FFFFFF' },
    modern:   { bg: '#FFFFFF', lines: '#e2e8f0', roads: '#cbd5e0', water: '#ebf8ff', textBg: '#1a202c', text: '#FFFFFF', frame: '#2d3748' },
    vintage:  { bg: '#F0E6D2', lines: '#D7C9AA', roads: '#B0A384', water: '#CVD7E2', textBg: '#5D4037', text: '#F0E6D2', frame: '#5D4037' },
    cyberpunk:{ bg: '#000000', lines: '#330033', roads: '#00d2ff', water: '#0b1e3d', textBg: '#00d2ff', text: '#000000', frame: '#00d2ff', glow: true }
};

// Canvas Setup
const canvas = document.getElementById('posterCanvas');
const ctx = canvas.getContext('2d');

// CACHE CANVAS (The secret to performance)
// We draw the heavy map vectors here. We only redraw this if map location changes.
const mapCache = document.createElement('canvas');
mapCache.width = 2480;
mapCache.height = 3508;
const mapCtx = mapCache.getContext('2d');

/**
 * INITIALIZATION
 */
function init() {
    // Initial draw to set background
    drawBackground(mapCtx);
    drawLabelsOnly(); // Draw text on blank background first
    fetchMapData(); // Then fetch map
}

/**
 * LOGIC: DATA FETCHING
 */
let fetchTimeout;
function debouncedFetch() {
    clearTimeout(fetchTimeout);
    fetchTimeout = setTimeout(fetchMapData, 600);
}

function updateZoom() {
    state.zoom = parseFloat(document.getElementById('zoomRange').value);
    debouncedFetch();
}

async function fetchMapData() {
    if(state.mode !== 'map') return;
    
    document.getElementById('loadingOverlay').style.display = 'block';
    state.isFetching = true;

    try {
        const range = state.zoom * 0.04;
        const bounds = `${state.lat - range},${state.lon - range},${state.lat + range},${state.lon + range}`;
        
        // Overpass API Query
        const query = `
            [out:json][timeout:25];
            (
              way["highway"](${bounds});
              way["waterway"](${bounds});
              way["railway"](${bounds});
            );
            out geom;
        `;

        const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
        const data = await res.json();
        
        state.mapData = data.elements;
        renderMapToCache(); // Heavy lifting happens here
        
    } catch (err) {
        console.error("Map Fetch Error", err);
        // Don't alert, just keep previous map if fail
    } finally {
        state.isFetching = false;
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

/**
 * LOGIC: RENDERING THE MAP (Heavy)
 * This draws to the hidden 'mapCache' canvas
 */
function renderMapToCache() {
    const t = themes[state.theme];
    
    // 1. Clear & Background
    mapCtx.fillStyle = t.bg;
    mapCtx.fillRect(0, 0, 2480, 3508);

    if (state.mode === 'star') {
        renderStars(mapCtx); // Placeholder for stars
        drawLabelsOnly();
        return;
    }

    if (!state.mapData) return;

    // Map Settings
    const scale = 45000 * state.zoom;
    const cx = 1240;
    const cy = 1350; // Map Center

    mapCtx.save();
    mapCtx.translate(cx, cy);

    // Filter Layers
    const layers = [
        { type: 'waterway', color: t.water, width: 8 },
        { type: 'railway', color: t.lines, width: 4 },
        { type: 'highway', subtype: 'residential', color: t.lines, width: 4 },
        { type: 'highway', subtype: 'primary', color: t.roads, width: t.glow ? 10 : 8 }
    ];

    layers.forEach(layer => {
        mapCtx.beginPath();
        state.mapData.forEach(el => {
            if(!el.tags || !el.geometry) return;
            
            // Check matches
            let match = false;
            if(layer.type === 'highway') {
                 const hw = el.tags.highway;
                 if(layer.subtype === 'primary' && ['motorway','trunk','primary','secondary'].includes(hw)) match = true;
                 else if(layer.subtype === 'residential' && !['motorway','trunk','primary','secondary'].includes(hw)) match = true;
            } else if (el.tags[layer.type]) {
                match = true;
            }

            if(match) {
                el.geometry.forEach((pt, i) => {
                    // Projection Math
                    const x = (pt.lon - state.lon) * scale * Math.cos(state.lat * Math.PI / 180);
                    const y = -(pt.lat - state.lat) * scale;
                    if(i===0) mapCtx.moveTo(x, y); else mapCtx.lineTo(x, y);
                });
            }
        });
        
        mapCtx.strokeStyle = layer.color;
        mapCtx.lineWidth = layer.width;
        mapCtx.lineCap = 'round';
        mapCtx.lineJoin = 'round';

        if(t.glow && layer.subtype === 'primary') {
            mapCtx.shadowBlur = 15;
            mapCtx.shadowColor = layer.color;
        } else {
            mapCtx.shadowBlur = 0;
        }
        
        mapCtx.stroke();
    });

    mapCtx.restore();
    
    // Draw Border
    mapCtx.strokeStyle = t.frame;
    mapCtx.lineWidth = 20;
    mapCtx.strokeRect(50, 50, 2380, 3408);

    // Now update the main visible canvas
    drawLabelsOnly();
}

function renderStars(ctx) {
    // Simple placeholder for star logic to prevent crash
    ctx.fillStyle = "#FFF";
    for(let i=0; i<800; i++) {
        ctx.beginPath();
        ctx.arc(Math.random()*2480, Math.random()*2500, Math.random()*3, 0, Math.PI*2);
        ctx.fill();
    }
}

/**
 * LOGIC: COMPOSITING (Light)
 * This combines the cached map + text. It runs on every keystroke.
 */
function drawLabelsOnly() {
    const t = themes[state.theme];

    // 1. Copy the cached map to main canvas (Instant!)
    ctx.drawImage(mapCache, 0, 0);

    // 2. Get Text Inputs
    const title = document.getElementById('txtTitle').value.toUpperCase();
    const sub = document.getElementById('txtSub').value;
    const tag = document.getElementById('txtTag').value;
    const font = document.getElementById('fontSelect').value;

    const centerX = 1240;
    const bottomY = 2850; // Anchor point for text

    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // --- TITLE ---
    const titleSize = 160; // Much larger
    ctx.font = `700 ${titleSize}px "${font}"`;
    const titleWidth = ctx.measureText(title).width;
    const titlePad = 60;
    
    // Title Background Box
    ctx.fillStyle = t.frame; // Used as contrast color
    ctx.fillRect(centerX - (titleWidth/2) - titlePad, bottomY - 100, titleWidth + (titlePad*2), titleSize * 1.3);
    
    // Title Text
    ctx.fillStyle = t.bg; // Text is color of background (knockout effect)
    ctx.fillText(title, centerX, bottomY);

    // --- SUBTITLE ---
    const subSize = 55;
    ctx.font = `400 ${subSize}px "${font}"`;
    const subWidth = ctx.measureText(sub).width;
    const subPad = 40;
    const subY = bottomY + 160;

    // Sub Background Box
    ctx.fillStyle = t.frame;
    ctx.fillRect(centerX - (subWidth/2) - subPad, subY - 40, subWidth + (subPad*2), subSize * 1.8);

    // Sub Text
    ctx.fillStyle = t.bg;
    ctx.fillText(sub, centerX, subY);

    // --- TAGLINE ---
    if(tag) {
        const tagSize = 40;
        ctx.font = `italic 400 ${tagSize}px "Georgia"`; // Classic serif for tagline
        const tagY = subY + 100;
        ctx.fillStyle = t.frame; // Or t.textBg depending on preference
        ctx.fillText(tag, centerX, tagY);
    }
}

function drawBackground(c) {
    c.fillStyle = themes[state.theme].bg;
    c.fillRect(0,0,2480,3508);
}

/**
 * UI HANDLERS
 */
function setTheme(name) {
    state.theme = name;
    document.querySelectorAll('.theme-grid .btn').forEach(b => b.classList.remove('active'));
    document.getElementById('t-'+name).classList.add('active');
    renderMapToCache(); // Re-render map with new colors
}

function setMode(m) {
    state.mode = m;
    document.getElementById('btn-map').className = m==='map'?'btn active':'btn';
    document.getElementById('btn-star').className = m==='star'?'btn active':'btn';
    document.getElementById('map-controls').style.display = m==='map'?'block':'none';
    
    // Clear cache and redraw
    renderMapToCache();
    if(m==='map' && !state.mapData) fetchMapData();
}

function handleSearch() {
    const q = document.getElementById('cityInput').value;
    if(q.length < 3) return;

    // Simple debounce for search
    clearTimeout(window.searchT);
    window.searchT = setTimeout(() => {
        fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=5`)
        .then(r=>r.json())
        .then(data => {
            const list = document.getElementById('suggestions');
            list.innerHTML = '';
            list.style.display = 'block';
            data.forEach(d => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerText = d.display_name;
                item.onclick = () => {
                    state.lat = parseFloat(d.lat);
                    state.lon = parseFloat(d.lon);
                    
                    // Auto-update text
                    const shortName = d.display_name.split(',')[0];
                    document.getElementById('txtTitle').value = shortName.toUpperCase();
                    document.getElementById('txtSub').value = `${state.lat.toFixed(4)}째 N / ${state.lon.toFixed(4)}째 W`;
                    
                    list.style.display = 'none';
                    fetchMapData();
                };
                list.appendChild(item);
            });
        });
    }, 500);
}

function downloadPoster() {
    const link = document.createElement('a');
    link.download = `Poster_${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png', 1.0);
    link.click();
}

// Start
init();

</script>
</body>
</html>
